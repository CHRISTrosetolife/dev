<html><head/><body><button id="record">record</button>
<button id="stop">stop</button>
<div class="sound-clips"/>
<script type="module">
  import {
    MediaRecorder,
    register
  } from &apos;https://jspm.dev/extendable-media-recorder&apos;;
  import {
    connect
  } from &apos;https://jspm.dev/extendable-media-recorder-wav-encoder&apos;;
  import breezystacklamejs from &apos;https://cdn.jsdelivr.net/npm/@breezystack/lamejs@1.2.7/+esm&apos;

  

  const record = document.getElementById(&apos;record&apos;);
  const stop = document.getElementById(&apos;stop&apos;);
  const soundClips = document.querySelector(&apos;.sound-clips&apos;);

  (async () =&gt; {


    let mr= await html_recorder_media()

    record.onclick = function() {
        const blob_mp3=html_recorder_media_start(mr)
    record.style.background = &quot;red&quot;;
    record.style.color = &quot;black&quot;;
    }


    stop.onclick = async function() {
      const blob_mp3=  await html_recorder_media_stop(mr)
    record.style.background = &quot;#5bc0de&quot;;
    record.style.color = &quot;white&quot;;
    console.log(&quot;recorder stopped&quot;);

    const clipName = prompt(&apos;Enter a name for your sound clip&apos;);
    const clipContainer = document.createElement(&apos;article&apos;);
    const clipLabel = document.createElement(&apos;p&apos;);
    const audio = document.createElement(&apos;audio&apos;);
    const deleteButton = document.createElement(&apos;button&apos;);

    clipContainer.classList.add(&apos;clip&apos;);

    audio.setAttribute(&apos;controls&apos;, &apos;&apos;);
    deleteButton.innerHTML = &quot;Delete&quot;;
    clipLabel.innerHTML = clipName;

    clipContainer.appendChild(audio);
    clipContainer.appendChild(clipLabel);
    clipContainer.appendChild(deleteButton);
    soundClips.appendChild(clipContainer);

    const audioURL = window.URL.createObjectURL(blob_mp3);
    audio.src = audioURL;

    deleteButton.onclick = function(e) {
        let evtTgt = e.target;
        evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
    }
          


    }
  })();

  function html_recorder_media_start(mr) {
  let AudioContext = window.AudioContext || window.webkitAudioContext;
  let audioContext = new AudioContext();
  let { media_recorder } = mr;
  media_recorder.start();
}
async function html_recorder_media_stop(mr) {
  let { media_recorder, chunks } = mr;
  let type = &quot;stop&quot;;
  return await new Promise((resolve) =&gt; {
    html_event_listener(media_recorder, type, async function on_stop() {
      html_event_listener_remove(media_recorder, type, on_stop);
      let blob = new Blob(chunks, {
        type: chunks[0].type,
      });
      let blob_mp3 = await html_wav_to_mp3(blob);
      list_remove_all(chunks);
      resolve(blob_mp3);
    });
    media_recorder.stop();
  });
}
function html_event_listener(element, type, lambda) {
  element.addEventListener(type, lambda);
}

function html_event_listener_remove(element, type, on_load) {
  element.removeEventListener(type, on_load);
}

async function html_wav_to_mp3(wav_blob) {
  return await new Promise((resolve, reject) =&gt; {
    let reader = new FileReader();
    reader.onload = function () {
      let arrayBuffer = this.result;
      let wavDecoder = breezystacklamejs.WavHeader.readHeader(
        new DataView(arrayBuffer),
      );
      let wavSamples = new Int16Array(
        arrayBuffer,
        wavDecoder.dataOffset,
        wavDecoder.dataLen / 2,
      );
      let mp3Encoder = new breezystacklamejs.Mp3Encoder(
        wavDecoder.channels,
        wavDecoder.sampleRate,
        128,
      );
      let mp3Buffer = mp3Encoder.encodeBuffer(wavSamples);
      let mp3Data = mp3Encoder.flush();
      let mp3BufferWithHeader = new Uint8Array(
        mp3Buffer.length + mp3Data.length,
      );
      mp3BufferWithHeader.set(mp3Buffer, 0);
      mp3BufferWithHeader.set(mp3Data, mp3Buffer.length);
      let mp3Blob = new Blob([mp3BufferWithHeader], {
        type: &quot;audio/mp3&quot;,
      });
      resolve(mp3Blob);
    };
    reader.onerror = function (e) {
      reject(e);
    };
    reader.readAsArrayBuffer(wav_blob);
  });
}

  async function html_recorder_media() {
    let port = await connect();
  await register(port);
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    error(&quot;getUserMedia not supported on your browser!&quot;);
  }
  let stream = await navigator.mediaDevices.getUserMedia({
    audio: true,
  });
  let media_recorder = new MediaRecorder(stream, {
    mimeType: &quot;audio/wav&quot;,
  });
  let result = {
    media_recorder,
    chunks: [],
  };
  media_recorder.ondataavailable = function (e) {
    result.chunks.push(e.data);
  };
  return result;
}
function list_remove_all(nexts) {
  nexts.length = 0;
}

</script></body></html>