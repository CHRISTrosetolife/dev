import { app_ceb_word_button_audio_none } from "./app_ceb_word_button_audio_none.mjs";
import { html_button_next_text } from "./html_button_next_text.mjs";
import { storage_local_initialize } from "./storage_local_initialize.mjs";
import { storage_local_set } from "./storage_local_set.mjs";
import { html_button_disable } from "./html_button_disable.mjs";
import { html_style_default_font_size } from "./html_style_default_font_size.mjs";
import { html_style_display_inline_block } from "./html_style_display_inline_block.mjs";
import { html_attribute_has } from "./html_attribute_has.mjs";
import { html_style_border_color } from "./html_style_border_color.mjs";
import { html_style_button_default_background_color } from "./html_style_button_default_background_color.mjs";
import { html_style_font_color_default_set } from "./html_style_font_color_default_set.mjs";
import { string_combine } from "./string_combine.mjs";
import { html_p } from "./html_p.mjs";
import { html_spacer_vertical_2 } from "./html_spacer_vertical_2.mjs";
import { app_ceb_correct_get } from "./app_ceb_correct_get.mjs";
import { app_ceb_alternatives_partial_matches_nexts } from "./app_ceb_alternatives_partial_matches_nexts.mjs";
import { html_disable } from "./html_disable.mjs";
import { html_enable } from "./html_enable.mjs";
import { html_style_hidden } from "./html_style_hidden.mjs";
import { list_includes } from "./list_includes.mjs";
import { html_button_width_full_text_click_up } from "./html_button_width_full_text_click_up.mjs";
import { list_get_or_last } from "./list_get_or_last.mjs";
import { or } from "./or.mjs";
import { number_power } from "./number_power.mjs";
import { integer_log } from "./integer_log.mjs";
import { equal_not } from "./equal_not.mjs";
import { list_concat_multiple } from "./list_concat_multiple.mjs";
import { list_slice } from "./list_slice.mjs";
import { html_clear_scroll_top_centered } from "./html_clear_scroll_top_centered.mjs";
import { html_style_alternate_short_p } from "./html_style_alternate_short_p.mjs";
import { app_ceb_atom_title_patterns } from "./app_ceb_atom_title_patterns.mjs";
import { app_ceb_atom_title } from "./app_ceb_atom_title.mjs";
import { app_ceb_level_size } from "./app_ceb_level_size.mjs";
import { each_range } from "./each_range.mjs";
import { add } from "./add.mjs";
import { mod_last_is } from "./mod_last_is.mjs";
import { html_button_width_full_text_click_alternate_short } from "./html_button_width_full_text_click_alternate_short.mjs";
import { string_combine_multiple } from "./string_combine_multiple.mjs";
import { html_style_button_default } from "./html_style_button_default.mjs";
import { html_style_wrong } from "./html_style_wrong.mjs";
import { object_copy_shallow } from "./object_copy_shallow.mjs";
import { list_last } from "./list_last.mjs";
import { html_style_display_block } from "./html_style_display_block.mjs";
import { greater_than } from "./greater_than.mjs";
import { app_ceb_quiz_settings } from "./app_ceb_quiz_settings.mjs";
import { html_div } from "./html_div.mjs";
import { list_without } from "./list_without.mjs";
import { app_ceb_audio } from "./app_ceb_audio.mjs";
import { app_ceb_word_english } from "./app_ceb_word_english.mjs";
import { list_after } from "./list_after.mjs";
import { number_is } from "./number_is.mjs";
import { list_random_item } from "./list_random_item.mjs";
import { html_element_style } from "./html_element_style.mjs";
import { html_style_width_full } from "./html_style_width_full.mjs";
import { html_style_default_border_margin } from "./html_style_default_border_margin.mjs";
import { app_learn_code_correct_timeout } from "./app_learn_code_correct_timeout.mjs";
import { app_learn_code_style_success } from "./app_learn_code_style_success.mjs";
import { html_style_display_none } from "./html_style_display_none.mjs";
import { html_style_click_width_min } from "./html_style_click_width_min.mjs";
import { html_button_text_click } from "./html_button_text_click.mjs";
import { string_chunk } from "./string_chunk.mjs";
import { app_ceb_word_button } from "./app_ceb_word_button.mjs";
import { html_style_default_initialize } from "./html_style_default_initialize.mjs";
import { html_buttons_next_previous } from "./html_buttons_next_previous.mjs";
import { list_scramble } from "./list_scramble.mjs";
import { http_storage } from "./http_storage.mjs";
import { ceb_group_path } from "./ceb_group_path.mjs";
import { list_first } from "./list_first.mjs";
import { list_get } from "./list_get.mjs";
import { each } from "./each.mjs";
import { list_index_last } from "./list_index_last.mjs";
import { equal } from "./equal.mjs";
import { add_1 } from "./add_1.mjs";
import { html_inner_set } from "./html_inner_set.mjs";
import { string_take } from "./string_take.mjs";
import { string_length } from "./string_length.mjs";
import { list_second } from "./list_second.mjs";
import { list_add_multiple } from "./list_add_multiple.mjs";
import { assert } from "./assert.mjs";
import { multiply } from "./multiply.mjs";
import { number_min } from "./number_min.mjs";
import { greater_than_equal } from "./greater_than_equal.mjs";
import { html_button_width_full_text_click } from "./html_button_width_full_text_click.mjs";
import { list_length } from "./list_length.mjs";
import { equal_1 } from "./equal_1.mjs";
import { html_style_bold } from "./html_style_bold.mjs";
import { list_add } from "./list_add.mjs";
import { list_adder } from "./list_adder.mjs";
import { subtract } from "./subtract.mjs";
import { subtract_1 } from "./subtract_1.mjs";
import { divide } from "./divide.mjs";
import { list_filter } from "./list_filter.mjs";
import { object_property_get } from "./object_property_get.mjs";
import { list_map } from "./list_map.mjs";
import { string_case_lower } from "./string_case_lower.mjs";
import { list_copy } from "./list_copy.mjs";
import { list_map_property } from "./list_map_property.mjs";
import { html_span } from "./html_span.mjs";
import { html_span_text } from "./html_span_text.mjs";
import { html_style_background_color } from "./html_style_background_color.mjs";
import { storage_local_get } from "./storage_local_get.mjs";
import { object_property_initialize } from "./object_property_initialize.mjs";
import { list_sort_string } from "./list_sort_string.mjs";
import { identity } from "./identity.mjs";
import { each_object } from "./each_object.mjs";
import { list_adder_unique } from "./list_adder_unique.mjs";
export async function app_ceb() {
  let root = html_style_default_initialize();
  html_style_default_font_size(3.5);
  let group_index = 0;
  let { group, definitions, inverted } = await http_storage(
    ceb_group_path(group_index),
  );
  let level_size = app_ceb_level_size();
  let settings_choices;
  storage_local_initialize(app_ceb, "position", {
    left: 0,
    right: list_index_last(group),
  });
  refresh_node();
  function refresh_node() {
    html_clear_scroll_top_centered(root);
    app_ceb_title();
    let { left, right } = storage_local_get(app_ceb, "position");
    let srl = subtract(right, left);
    let j = 1;
    if (equal_not(srl, 0)) {
      each_range(level_size, (i) => {
        let factor = divide(add_1(srl), level_size);
        let m = multiply(factor, i);
        let s = subtract_1(multiply(factor, add_1(i)));
        let left_next = add(left, m);
        let right_next = add(left, s);
        let atom_left = list_get(group, left_next);
        let atom_right = list_get_or_last(group, right_next);
        let text = app_ceb_atom_title(group, atom_left, atom_right);
        html_button_width_full_text_click_alternate_short(
          root,
          app_ceb_atom_title_patterns(),
          string_combine_multiple([j, ". ", text]),
          function on_click() {
            storage_local_set(app_ceb, "position", {
              left: left_next,
              right: right_next,
            });
            refresh_node();
          },
        );
        j++;
      });
    }
    html_button_width_full_text_click(root, "📃 review", refresh_pair_list);
    if (left === right) {
      html_button_width_full_text_click(
        root,
        string_combine(j++, ". 🎓 learn"),
        () => {
          refresh_learn(0);
        },
      );
    }
    ("🟠🔵");
    html_button_width_full_text_click(
      root,
      string_combine(j++, ". 📝 quiz ( 🟢 easy )"),
      () => {
        quizzes_start([3]);
      },
    );
    html_button_width_full_text_click(
      root,
      string_combine(j++, ". 📝 quiz ( 🟡 medium )"),
      () => {
        quizzes_start([2]);
      },
    );
    html_button_width_full_text_click(
      root,
      string_combine(j++, ". 📝 quiz ( 🔴 hard )"),
      () => {
        quizzes_start([1]);
      },
    );
    html_button_width_full_text_click(
      root,
      string_combine_multiple([j++, ". ", html_button_next_text()]),
      () => {
        app_ceb_next();
        refresh_node();
      },
    );
    function app_ceb_next() {
      let { left, right } = storage_local_get(app_ceb, "position");
      let n = add_1(subtract(right, left));
      let count = integer_log(n, level_size);
      let level = number_power(level_size, add_1(count));
      if (mod_last_is(right, level) && equal_not(left, 0)) {
        storage_local_set(app_ceb, "position", {
          left: add_1(subtract(right, level)),
          right: right,
        });
      } else {
        let r1 = add_1(right);
        storage_local_set(app_ceb, "position", {
          left: r1,
          right: r1,
        });
      }
    }
    html_button_width_full_text_click_up(root, up_onclick);
    function up_onclick() {
      let { left, right } = storage_local_get(app_ceb, "position");
      while (true) {
        app_ceb_next();
        let { left: l, right: r } = storage_local_get(app_ceb, "position");
        if (or(equal(left, l), equal(right, r))) {
          break;
        }
      }
      refresh_node();
    }
  }
  function app_ceb_title() {
    let { left, right } = storage_local_get(app_ceb, "position");
    let gl = list_get(group, left);
    let gr = list_get_or_last(group, right);
    let text = app_ceb_atom_title(group, gl, gr);
    html_style_alternate_short_p(root, app_ceb_atom_title_patterns(), text);
  }
  async function refresh_quiz(settings) {
    html_clear_scroll_top_centered(root);
    let no_mistakes = true;
    let { pair, chunk_size, forwards } = settings;
    assert(number_is, [chunk_size]);
    let concat = atoms_slice_concat();
    let pairs_other = list_without(concat, pair);
    let [cebuano, english] = pair;
    if (0) [cebuano, english] = ["gikan", "from"];
    let english_alternatives = list_without(
      object_property_get(definitions, cebuano),
      english,
    );
    let cebuano_alternatives = list_without(
      object_property_get(inverted, english),
      cebuano,
    );
    pairs_other = list_filter(pairs_other, (po) => {
      let [c, e] = po;
      if (
        or(
          list_includes(cebuano_alternatives, c),
          list_includes(english_alternatives, e),
        )
      ) {
        return false;
      }
      return true;
    });
    let answer;
    let pair_other = list_random_item(pairs_other);
    if (0) pair_other = ["ila", "acknowledge"];
    let answer_other_get;
    let alternatives;
    if (forwards) {
      await app_ceb_word_button(root, cebuano);
      answer = english;
      answer_other_get = list_second;
      alternatives = english_alternatives;
    } else {
      app_ceb_word_english(root, english);
      answer = cebuano;
      answer_other_get = list_first;
      alternatives = cebuano_alternatives;
    }
    let quiz_container;
    let button_ready = html_button_width_full_text_click(
      root,
      "🏁 ready",
      () => {
        html_style_display_none(button_ready);
        html_style_display_block(quiz_container);
      },
    );
    quiz_container = html_div(root);
    let component_display_none;
    if (equal_1(chunk_size)) {
      component_display_none = quiz_container;
    } else {
      component_display_none = button_ready;
    }
    html_style_display_none(component_display_none);
    let answer_other = answer_other_get(pair_other);
    let answer_element = html_p(quiz_container);
    let answer_element_left = html_span(answer_element);
    let answer_element_right = html_span_text(answer_element, "?");
    html_style_display_inline_block(answer_element_right);
    html_style_bold(answer_element_left);
    let style = html_element_style(answer_element);
    html_style_default_border_margin(style);
    html_style_width_full(answer_element);
    html_style_border_color(
      answer_element,
      html_style_button_default_background_color(),
    );
    let index = 0;
    let correct_choices = string_chunk(answer, chunk_size);
    let other_choices = string_chunk(answer_other, chunk_size);
    let choices = list_copy(correct_choices);
    list_add_multiple(choices, other_choices);
    list_scramble(choices);
    choices = list_map(choices, string_case_lower);
    let buttons = list_adder((la) => {
      each(choices, (choice) => {
        let button = html_button_text_click(quiz_container, choice, () => {
          let correct = app_ceb_correct_get(answer, chunk_size, index);
          if (equal(choice, correct)) {
            html_disable(button);
            each(
              list_map_property(buttons, "button"),
              html_style_button_default,
            );
            index = add_1(index);
            update_partials();
            let last_is = greater_than_equal(
              multiply(index, chunk_size),
              string_length(answer),
            );
            let first = last_is ? "✅ " : "";
            let take_count = number_min(
              multiply(index, chunk_size),
              string_length(answer),
            );
            if (last_is) {
              html_style_display_none(answer_element_right);
            }
            html_inner_set(
              answer_element_left,
              string_combine(first, string_take(answer, take_count)),
            );
            if (last_is) {
              app_learn_code_style_success(answer_element);
              html_style_hidden(button);
            }
            app_learn_code_style_success(button);
            update_partials();
            app_learn_code_correct_timeout(async () => {
              html_style_hidden(button);
              if (last_is) {
                if (0) html_style_background_color(root, "#d3f8d3");
                app_learn_code_style_success(answer_element);
                await app_ceb_audio(cebuano);
                if (0) html_style_background_color(root, "white");
                if (equal(settings, list_last(settings_choices))) {
                  refresh_node();
                } else {
                  let after = list_after(settings_choices, settings);
                  refresh_quiz(after);
                }
              }
            });
          } else {
            html_style_wrong(button);
            if (no_mistakes) {
              list_add(settings_choices, object_copy_shallow(settings));
              no_mistakes = false;
            }
          }
        });
        la({
          button,
          choice,
        });
        html_style_click_width_min(button);
      });
    });
    update_partials();
    html_spacer_vertical_2(root);
    html_button_width_full_text_click_up(root, refresh_node);
    function update_partials() {
      let nexts = app_ceb_alternatives_partial_matches_nexts(
        answer,
        chunk_size,
        index,
        alternatives,
      );
      each(buttons, (b) => {
        let { button, choice } = b;
        let disabled_is = html_attribute_has(button, "disabled");
        if (disabled_is) {
          html_enable(button);
          html_style_button_default(button);
          html_style_font_color_default_set(button);
        }
        if (list_includes(nexts, choice)) {
          html_button_disable(button);
        }
      });
    }
  }
  async function refresh_pair_list() {
    html_clear_scroll_top_centered(root);
    let concat = atoms_slice_concat();
    let lookup = {};
    let cebuanos = list_adder_unique((la) =>
      each(concat, (pair) => {
        let [cebuano, english] = pair;
        la(cebuano);
        let e = object_property_initialize(lookup, cebuano, []);
        list_add(e, english);
      }),
    );
    list_sort_string(cebuanos, identity);
    each_object(lookup, (key, value) => list_sort_string(value, identity));
    each(cebuanos, (cebuano) => {
      app_ceb_word_button_audio_none(root, cebuano);
      each(object_property_get(lookup, cebuano), (english) =>
        app_ceb_word_english(root, english),
      );
    });
    html_button_width_full_text_click_up(root, refresh_node);
  }
  async function refresh_learn(pair_index) {
    html_clear_scroll_top_centered(root);
    let concat = atoms_slice_concat();
    let pair = list_get(concat, pair_index);
    let [cebuano, english] = pair;
    await app_ceb_word_button(root, cebuano);
    app_ceb_word_english(root, english);
    html_buttons_next_previous(
      root,
      (pair_index) => {
        if (greater_than(pair_index, list_index_last(concat))) {
          refresh_node();
        } else {
          refresh_learn(pair_index);
        }
      },
      pair_index,
      list_length(concat),
    );
    html_button_width_full_text_click_up(root, refresh_node);
  }
  function atoms_slice_concat() {
    let atoms = atoms_slice();
    let concat = list_concat_multiple(atoms);
    return concat;
  }
  function quizzes_start(chunk_sizes) {
    let atoms = atoms_slice();
    settings_choices = app_ceb_quiz_settings(atoms, chunk_sizes);
    refresh_quiz(list_first(settings_choices));
  }
  function atoms_slice() {
    let { left, right } = storage_local_get(app_ceb, "position");
    let atoms = list_slice(group, left, add_1(right));
    return atoms;
  }
}
